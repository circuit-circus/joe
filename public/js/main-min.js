function startJoe(){var e=getFirst();insertQuestion(e),$("body").on("click",".first-answer",function(n){$(".first-answer").addClass("elimination-answer").removeClass("first-answer");var t=$(this).text(),i=$(".chat-answer-template").clone();i.text(t),i.removeClass("chat-answer-template").addClass("chat-answer"),$(".conversation-container").append(i),"positive-answer"===n.target.id&&finishJoe(e),"negative-answer"===n.target.id&&eliminationRound()})}function eliminationRound(){if(questionCounter>=question_data.length)return void finishJoe();var e=question_data[questionCounter];insertQuestion(e),$(".elimination-answer").off("click"),$(".elimination-answer").on("click",function(e){var n=$(this).text(),t=$(".chat-answer-template").clone();t.text(n),t.removeClass("chat-answer-template").addClass("chat-answer"),$(".conversation-container").append(t);var i;switch("positive-answer"===e.target.id&&(i="pos"),"negative-answer"===e.target.id&&(i="neg"),questionCounter){case 0:choices.size="pos"===i?{$in:[1]}:{$in:[2]};break;case 1:choices.strength="pos"===i?{$in:[1]}:{$in:[2]};break;case 2:"pos"===i?choices.milk={$in:[1]}:"neg"===i&&(choices.milk={$in:[0]},choices.milk_froth={$in:[0]});break;case 3:choices.milk_froth="pos"===i?{$in:[1]}:{$in:[2]}}questionCounter++,checkDrinkAvailability(function(e){e>1?eliminationRound():finishJoe(availableDrinkArray[0])})})}function getFirst(){var e=[],n=(new Date).getHours();e=n>=6&&11>n?["Goodmorning [VISITOR]!","Hi [VISITOR], hope you're having a great morning!"]:n>=11&&14>n?["Hi there [VISITOR]!","Hello [VISITOR], how are you?","Hi [VISITOR]! So nice to see you.","Welcome [VISITOR]!"]:n>=14&&18>n?["Goodafternoon [VISITOR]!","Hi [VISITOR], so nice to see you this afternoon."]:n>=18&&23>n?["Goodevening [VISITOR]!","Goodevening [VISITOR], hope you're doing fine this lovely evening","Hi [VISITOR], in the mood for an evening coffee?"]:["Hi there [VISITOR]!","Hello [VISITOR]!"];var t=e[Math.floor(Math.random()*e.length)],i=["buddy","friend"],o=getVisitorInfo(),a=o.first_name?o.first_name:i[Math.floor(Math.random()*i.length)];t=t.replace("[VISITOR]",a);var s=COPENHAGEN_LOC;sendToPath("post","/weather",s,function(e,n){console.log(n)});var r={phrase:t+" How about an Espresso?",_id:"589b134671f90d703a4cf695",name:"Espresso",positive_answer:"Yeah, that sounds great. Hit me, Joe!",negative_answer:"No thanks, I'm in the mood for something different",dispenser_number:4};return r}function insertQuestion(e){var n=$(".chat-question-template").clone();n.text(e.phrase),n.removeClass("chat-question-template").addClass("chat-question"),$(".conversation-container").append(n),$(".answer-option#positive-answer").text(e.positive_answer),$(".answer-option#negative-answer").text(e.negative_answer),$(".conversation-container").animate({scrollTop:$(document).height()},750)}function checkDrinkAvailability(e){sendToPath("post","/drinks",choices,function(n,t){availableDrinkArray=t,e(availableDrinkArray.length)})}function getVisitorInfo(){var e={first_name:"Nina",last_name:"HÃ¸jholdt",last_drink:{drink_name:"Espresso",drink_id:"589b134671f90d703a4cf695"}};return e}function finishJoe(e){console.log(e);var n=$('<div class="chat-question chat-buble"></div>');n.text("Great! Here's your "+e.name),$(".conversation-container").append(n),$(".conversation-container").animate({scrollTop:$(document).height()},750),$(".answer-container").hide(),sendToPath("post","/dispense",e,function(e,n){console.log(n)})}function sendToPath(e,n,t,i,o){var a=o||i,s={url:n,type:e,contentType:"application/json",dataType:"json",data:JSON.stringify(t),xhrFields:{withCredentials:!0},success:function(e){if(1==e.status){if("NOT_LOGGED_IN"===e.code)return $.notify("You are no longer logged in - redirecting you to the front page","failure"),void setTimeout(function(){handleRegistrationNextStep(e.next_step)},3e3);a(e)}else a(void 0,e)},error:function(e){a(e.responseJSON?e.responseJSON:{status:1,message:"Action failed, please try again later"})}};o&&(s.xhr=function(){var e=new window.XMLHttpRequest;return e.upload&&e.upload.addEventListener("progress",function(e){if(e.lengthComputable){var n=e.loaded/e.total;i(n)}},!1),e}),$.ajax(s)}var socket=io(),COPENHAGEN_LOC={latitude:55.67594,longitude:12.56553},bannedDrinkArray=[],availableDrinkArray=[],choices={},questionCounter=0,question_data=[{phrase:"Big or small?",positive_answer:"Small for me",negative_answer:"Big, please!"},{phrase:"How strong?",positive_answer:"Not too strong",negative_answer:"Give me a kick!"},{phrase:"You want milk in that?",positive_answer:"Yes, please",negative_answer:"I like it black like my soul!"},{phrase:"How frothy you want that milk?",positive_answer:"Lots of froth",negative_answer:"No froth"}];$(document).ready(function(){socket.on("buttonPress",function(e){"L"===e?$("#positive-answer").click():"R"===e&&$("#negative-answer").click()}),startJoe()});